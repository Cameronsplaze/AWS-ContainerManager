name: cdk-synth

on:
  workflow_dispatch: {}
  pull_request:
    types:
      # For Synth
      - opened
      - reopened
      - synchronize
      - edited
      # For Deploy
      - closed
    # NOTE: You CAN'T have the `paths` key here!!
    #    if you do, and the PR doesn't trigger this,
    #    you won't be able to merge it.
    #   (Apart of dependabot updates. See the
    #    README.md in this dir for more details...)
    branches:
      - main



env:
  EXAMPLES_PATH: ./Examples # No trailing slash plz!

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setup-matrix.outputs.example-config-files }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup matrix
        id: setup-matrix
        run: |
          file_list=$(cd "${{ env.EXAMPLES_PATH }}" && find * -regextype egrep -regex '.*ya?ml$')
          json_list=$(echo $file_list | jq --raw-input --compact-output 'split(" ")')
          echo "example-config-files=$json_list" >> "$GITHUB_OUTPUT"

      - name: DEBUG
        run: |
          echo "event type is ${{ github.event.action }}"
          echo "head ref is ${{ github.head_ref }}"

  cdk-synth:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    needs:
      - setup-matrix
    strategy:
      matrix:
        example-config: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: ./.github/workflows/composite-setup-python

      - name: Install NPM Stuff (aws-cdk)
        run: |
          ### Setup NPM for non-root:
          mkdir ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "PATH=~/.npm-global/bin:$PATH" >> "$GITHUB_ENV"
          ### Update:
          make update-npm

      - name: "Synthesize: ${{ matrix.example-config }}"
        run: make cdk-synth config-file="${{ env.EXAMPLES_PATH }}/${{ matrix.example-config }}"

  cdk-deploy:
    # If the PR is merged, or if we manually trigger it.
    if: github.event.pull_request.merged || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs:
      - setup-matrix
    steps:
      - name: "test"
        run: echo TODO
