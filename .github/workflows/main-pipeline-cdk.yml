name: Main Pipeline - Deploy CDK

on:
  workflow_dispatch: {}

  pull_request:
    types:
      # For Deploy
      - closed
    # NOTE: You CAN'T have the `paths` key here!!
    #    if you do, and the PR doesn't trigger this,
    #    you won't be able to merge it.
    #   (Apart of dependabot updates. See the
    #    README.md in this dir for more details...)
    branches:
      - main

## If another similar workflow is running, kill it:
# https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


permissions:
  id-token: write
  contents: read

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      deploy-matrix: ${{ steps.setup-deploy.outputs.container-id-files }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup cdk-deploy Matrix
        id: setup-deploy
        run: |
          github_vars_list=$(echo "${{ vars.DEPLOY_ENVIRONMENTS }}" | tr '\r\n' ' ')
          json_list=$(echo $github_vars_list | jq --raw-input --compact-output 'split(" ")')
          echo "container-id-files=$json_list" >> "$GITHUB_OUTPUT"
          if [ $json_list == '[]' ] && ([ ${{ github.event.pull_request.merged }} == 'true' ] || [ ${{ github.event_name }} == 'workflow_dispatch' ]); then
              echo "> [!WARNING]" >> $GITHUB_STEP_SUMMARY
              echo "> **No deploy environments found**, skipping deployments. Populate the 'DEPLOY_ENVIRONMENTS' GH Variable to change." >> $GITHUB_STEP_SUMMARY
              echo "> More info at `./.github/workflows/README.md#forking-this-repo`" >> $GITHUB_STEP_SUMMARY
          fi

  cdk-deploy-base:
    ## If the PR is merged, or if we manually trigger it (MAIN ONLY):
    #    - needs.setup-matrix.outputs.deploy-matrix != '[]': Only run if there's something to deploy.
    #    - (github.event_name block): Only run if it's a PR *merge* or on workflow_dispatch.
    if: |
      needs.setup-matrix.outputs.deploy-matrix != '[]' &&
      (
        ( github.event_name == 'pull_request' && github.event.pull_request.merged ) ||
        ( github.event_name == 'workflow_dispatch' )
      )
    runs-on: ubuntu-latest
    needs:
      - setup-matrix
    steps:
      - uses: actions/checkout@v5

      ## Install Everything / Setup Env Vars:
      - name: Setup CDK
        uses: ./.github/workflows/composite-setup-cdk
        with:
          secrets: ${{ toJson(secrets) }}
          vars: ${{ toJson(vars) }}

      ## Deploy the Base Stack:
      - name: Deploy Base Stack
        run: make cdk-deploy-base

  cdk-deploy-leaf:
    runs-on: ubuntu-latest
    needs:
      - setup-matrix
      - cdk-deploy-base
    strategy:
      # Since they all use the Base Stack, only one can create/update at a time:
      max-parallel: 1
      matrix:
        container-id: ${{ fromJson(needs.setup-matrix.outputs.deploy-matrix) }}
    environment: "${{ matrix.container-id }}"
    name: "${{ matrix.container-id }}"
    steps:
      - uses: actions/checkout@v5

      - name: Setup/Check Environment Variables
        run: |
          ## IF CONFIG_PATH var doesn't exist:
          if [[ -z "${{ vars.CONFIG_PATH }}" ]]; then
            echo "> [!CAUTION]" >> $GITHUB_STEP_SUMMARY
            echo "> **Required EnvVar Not Set**, exiting. Populate the '<GH_Environment>.CONFIG_PATH' GH Variable to change." >> $GITHUB_STEP_SUMMARY
          ## IF the file inside CONFIG_PATH is missing:
          elif [[ ! -f "${{ vars.CONFIG_PATH }}" ]]; then
            echo "> [!CAUTION]" >> $GITHUB_STEP_SUMMARY
            echo "> **Config File Not Found at '${{ vars.CONFIG_PATH }}'**, exiting." >> $GITHUB_STEP_SUMMARY
            echo "> (I.e good example: \`CONFIG_PATH=./Examples/Minecraft.java.example.yaml\`)" >> $GITHUB_STEP_SUMMARY
          ## ELSE, all good:
          else
            ## SUCCESS!!!
            exit 0
          fi
          ## One of the checks failed, give extra info and fail:
          echo "> More info at: $(git config --get remote.origin.url)/blob/main/.github/workflows/README.md" >> $GITHUB_STEP_SUMMARY
          exit -1

      ## Install Everything / Setup Env Vars:
      - name: Setup CDK
        uses: ./.github/workflows/composite-setup-cdk
        with:
          secrets: ${{ toJson(secrets) }}
          vars: ${{ toJson(vars) }}

      ## Deploy the Leaf Stack:
      - name: "Deploying: ${{ matrix.container-id }}"
        # CONTAINER_ID: Same as the GH Environment name, so it and deployments are one-to-one.
        run: |
          make cdk-deploy-leaf \
            config-file="${{ vars.CONFIG_PATH }}" \
            container-id=${{ matrix.container-id }}
